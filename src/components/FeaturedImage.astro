---
import type { CollectionEntry } from "astro:content";
import fs from "fs";
import path from "path";
import { imageSizeFromFile } from "image-size/fromFile";
import { JSDOM } from "jsdom";
import Picture from "./Picture.astro";

type Props = {
  featured: NonNullable<CollectionEntry<"blog">["data"]["featured"]>;
};

const { featured } = Astro.props;
let { name, ext } = path.parse(featured.image || "");
ext ||= ".svg";
const dir = "/assets/images";
const src = `${dir}/${name}/${name}${ext}`;
let width,
  height,
  color = featured.color || "",
  alt;

// Calculate the width and height if not provided
if (!width || !height) {
  const source = dir.replace(/^\//, "./public/");
  if (ext === ".svg") {
    const file = fs.readFileSync(
      path.resolve(source, `${name}/${name}${ext}`),
      "utf8"
    );
    const svgDom = new JSDOM(file).window.document.getElementsByTagName(
      "svg"
    )[0];
    const svgWidth = svgDom.getAttribute("width");
    const svgHeight = svgDom.getAttribute("height");
    if (svgWidth) {
      width = parseInt(svgWidth, 10);
    }
    if (svgHeight) {
      height = parseInt(svgHeight, 10);
    }
    color =
      color ||
      svgDom.getAttribute("fill") ||
      svgDom.children[0].getAttribute("fill") ||
      "";
  } else {
    const dimension = await imageSizeFromFile(
      path.resolve(source, `${name}/${name}_medium${ext}`)
    );
    width = Math.min(dimension.width, 900);
    height = dimension.height * (width / dimension.width);
  }
}

const maxWidth = 985;
const maxHeight = 482;
width = width || maxWidth;
height = height || maxHeight;
color = color || "#f5f2f0";
alt = alt || "";

const wRatio = height / width;
const hRatio = width / height;

if (width > maxWidth) {
  width = maxWidth;
  height = Math.floor(width * wRatio);
  if (height < maxHeight) {
    height = maxHeight;
    width = Math.floor(height * hRatio);
  }
}
---

<div class="header__feature" aria-hidden="true">
  <div class="featured__image" style=`background-color: ${color};`>
    {
      ext === ".svg" ? (
        <div style={`background-color: ${color}`}>
          <img
            src={`${dir}/${name}/${name}${ext}`}
            alt={`${alt}`}
            role="presentation"
            loading="lazy"
            width={`${width}`}
            height={`${height}`}
          />
        </div>
      ) : (
        <Picture src={src} alt="" />
      )
    }
  </div>
  {
    featured.author &&
      (featured.authorLink?.match(/unsplash/) ? (
        // prettier-ignore
        <div class="featured__credit">Photo by <a href={featured.authorLink} target="_blank" rel="noopener" tabindex="-1">{featured.author}</a> on <a href="https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText" target="_blank" rel="noopener" tabindex="-1">Unsplash</a>
        </div>
      ) : featured.author.match(/chatGPT/) ? (
        // prettier-ignore
        <div class="featured__credit">This image was created using <a href="https://chatgpt.com/" target="_blank">ChatGPT (DALLÂ·E 3)</a></div>
      ) : featured.authorLink?.match(/artvee/) ? (
        // prettier-ignore
        <div class="featured__credit">Photo from <a href={featured.authorLink} target="_blank" rel="noopener" tabindex="-1">{featured.author}</a> on <a href="https://artvee.com/" target="_blank" rel="noopener" tabindex="-1">Artvee</a></div>
      ) : (
        ""
      ))
  }
</div>
